# RFC: OpenSNAP — Open Self‑Negotiating APIs Protocol

**Version:** 1.0  
**Date:** 2025-04-23  
**Authors:** Cashputation Contributors

---

## 1. Introduction
OpenSNAP defines a minimal, machine‑to‑machine negotiation protocol for metered API calls. Agents discover endpoint pricing, negotiate a bid, attach a payment voucher, and invoke the API—all in a single HTTP interaction. Settlement occurs off‑protocol via a pluggable backend (blockchain channels, Interledger, centralized ledger).

## 2. Goals
- **Protocol‑First**: Keep the handshake independent of any payment rail.  
- **Self‑Negotiating**: Enable agents to programmatically fetch prices, offer bids, and pay per call.  
- **Voucher‑Based**: Carry proof of payment in HTTP headers, verifiable in real time.  
- **Extensible**: Support static and dynamic pricing algorithms.

## 3. Extended OpenAPI Spec
Each operation in `openapi.json` MUST include these `x-` extensions:

```jsonc
"paths": {
  "/video/generate": {
    "post": {
      "summary": "Generate a video",
      "x-price-base": 0.001,
      "x-pricing-algo": "static",
      "x-min-price": 0.0005,
      "x-max-price": 0.01,
      // ... requestBody, responses ...
    }
  }
}
```

- **x-price-base**: Base unit price (in chosen currency units).  
- **x-pricing-algo**: Identifier (e.g. `static`, `time-of-day`, `load-based`).  
- **x-min-price** / **x-max-price**: Permissible bid range.

## 4. Handshake Messages

### 4.1 CALL-OFFER
Client sends HTTP header:
```
X-OpenSNAP-Offer: {"endpoint":"/video/generate","bid":0.002}
```
- `endpoint`: Path of the operation.  
- `bid`: Numeric value the client agrees to pay.

### 4.2 CALL-ACK / CALL-REJECT
Server validates `bid ∈ [min, max]`:
- **CALL-ACK**: Respond `200 OK`, proceed to invocation.  
- **CALL-REJECT**: Respond `402 Payment Required` with error details.

### 4.3 Payment Voucher
Client attaches:
```
X-OpenSNAP-Voucher: <opaque-blob>
```
- Opaque proof generated by an adapter (HMAC, ILP STREAM, Lightning invoice, JWT).  
- Server verifies voucher matches the CALL-OFFER and covers the bid.

## 5. Invocation & Response
If voucher verification succeeds, server processes the request body and returns the API response as usual (JSON or binary). For media endpoints, it may return `Content-Type: video/mp4`, etc.

## 6. Settlement
Actual fund transfer is performed asynchronously via the chosen payment adapter:
- **Blockchain channels**: Batch‑settle on‑chain.  
- **Interledger STREAM**: Continuous micropayment streams.  
- **Centralized ledger**: Internal credit tokens or Stripe integration.  

Settlement details are outside the core OpenSNAP handshake.

## 7. Example Workflow

1. **Discover** prices: `GET /openapi.json`.  
2. **Create Offer**: Read `x-price-base`, apply pricing algorithm, ensure `min ≤ bid ≤ max`.  
3. **Generate Voucher**: Adapter: HMAC(vendor_secret, offer_json) or ILP STREAM packet.  
4. **CALL**:
   - `POST /video/generate`
   - Headers: `X-OpenSNAP-Offer`, `X-OpenSNAP-Voucher`  
   - Body: `{ "prompt": "..." }`  
5. **ACK + Invoke**: Server returns `200 OK` and response payload.  
6. **Settle**: Off‑protocol settlement completes channel/layer settlement.

## 8. Adapters (Reference Implementations)
- **HMAC Voucher**: `voucher = HMAC(secret, offer_json)`  
- **ILP STREAM**: Packet‑based voucher with STREAM.  
- **Lightning**: Use off‑chain channels for high‑volume calls.  
- **JWT Tokens**: Centralized credit token signed by billing server.

## 9. Security Considerations
- **Replay Protection**: Include nonces or timestamps in voucher payload.  
- **Rate Limiting**: Prevent griefing with dust calls or rapid small bids.  
- **Adapter Audits**: Smart contracts or ILP connectors must be production‑hardened.

## 10. Governance & Extension
- **Versioning**: Use semantic versions in `openapi.json` (`x-opensnap-version`).  
- **New Fields**: Extensions must be prefixed `x-OpenSNAP-` and documented in updates to this RFC.  
- **Community Process**: Protocol changes proposed via GitHub PRs and `rfc.md` revisions.

---

## License
Apache 2.0 © Cashputation Contributors

